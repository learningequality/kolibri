<template>

  <core-base :topLevelPageName="topLevelPageName">
    <div slot="app-bar-actions">
      <channel-switcher @switch="switchChannel"/>

      <ui-icon-button
        icon="search"
        type="secondary"
        color="white"
        :ariaLabel="$tr('search')"
        @click="toggleSearch"/>
    </div>
    <breadcrumbs slot="above" class="breadcrumbs"/>
    <component class="content" slot="content" :is="currentPage"/>

    <div slot="below" class="search-pane" v-show="searchOpen">
      <search-widget :showTopics="exploreMode"/>
    </div>

    <!-- this is not used, but necessary for vue-router to function -->
    <router-view/>

  </core-base>

</template>


<script>

  const constants = require('../state/constants');
  const PageNames = constants.PageNames;
  const PageModes = constants.PageModes;
  const getters = require('../state/getters');
  const actions = require('../actions');
  const store = require('../state/store');
  const TopLevelPageNames = require('kolibri.coreVue.vuex.constants').TopLevelPageNames;

  module.exports = {
    $trNameSpace: 'learn',
    $trs: {
      search: 'search',
    },
    components: {
      'search-widget': require('./search-widget'),
      'explore-page': require('./explore-page'),
      'content-page': require('./content-page'),
      'learn-page': require('./learn-page'),
      'scratchpad-page': require('./scratchpad-page'),
      'content-unavailable-page': require('./content-unavailable-page'),
      'core-base': require('kolibri.coreVue.components.coreBase'),
      'ui-icon-button': require('keen-ui/src/UiIconButton'),
      'channel-switcher': require('kolibri.coreVue.components.channelSwitcher'),
      'breadcrumbs': require('./breadcrumbs'),
    },
    methods: {
      toggleSearch() {
        this.toggleSearch();
      },
      switchChannel(channelId) {
        let rootPage;
        if (this.pageMode === constants.PageModes.EXPLORE) {
          rootPage = constants.PageNames.EXPLORE_CHANNEL;
        } else {
          rootPage = constants.PageNames.LEARN_CHANNEL;
        }
        this.clearSearch();
        this.$router.push({
          name: rootPage,
          params: { channel_id: channelId },
        });
      },
    },
    computed: {
      topLevelPageName() {
        if (this.exploreMode) {
          return TopLevelPageNames.LEARN_EXPLORE;
        }
        return TopLevelPageNames.LEARN_LEARN;
      },
      currentPage() {
        if (this.pageName === PageNames.EXPLORE_CHANNEL ||
          this.pageName === PageNames.EXPLORE_TOPIC) {
          return 'explore-page';
        }
        if (this.pageName === PageNames.EXPLORE_CONTENT ||
          this.pageName === PageNames.LEARN_CONTENT) {
          return 'content-page';
        }
        if (this.pageName === PageNames.LEARN_CHANNEL) {
          return 'learn-page';
        }
        if (this.pageName === PageNames.SCRATCHPAD) {
          return 'scratchpad-page';
        }
        if (this.pageName === PageNames.CONTENT_UNAVAILABLE) {
          return 'content-unavailable-page';
        }
        return null;
      },
      exploreMode() {
        return this.pageMode === PageModes.EXPLORE;
      },
    },
    vuex: {
      getters: {
        pageMode: getters.pageMode,
        pageName: state => state.pageName,
        searchOpen: state => state.searchOpen,
      },
      actions: {
        toggleSearch: actions.toggleSearch,
        clearSearch: actions.clearSearch,
      },
    },
    store, // make this and all child components aware of the store
  };

</script>


<style lang="stylus" scoped>

  @require '~kolibri.styles.definitions'
  @require 'learn.styl'

  .search-pane
    background-color: $core-bg-canvas
    overflow-y: scroll
    position: fixed
    top: 0
    left: 0
    height: 100%
    width: 100%
    z-index: 1
    @media screen and (min-width: $portrait-breakpoint + 1)
      padding-left: $nav-width

  .content
    width-auto-adjust()
    margin: auto

</style>
